---
title: "RLMS_tasks"
author: "Dmitriy Tsimokha"
date: "12/20/2020"
output: html_document
---

Набор задач по парному/непарному t-test и хи-квадрату (chi-square) на данных RLMS.

Идём на сайт ВШЭ с данными [RLMS](https://www.hse.ru/rlms/spss) - данные необходимо загружать в формате **SPSS (.sav)**.

В качестве примера выберем [**"Данные по индивидам IBM SPSS" по репрезентативной выборке из Волны 28 (2019)**](https://www.hse.ru/data/2020/08/30/1579120387/r28i_os_32.zip). Для загрузки данных необходимо будет авторизироваться на сайте ВШЭ, после чего можно скачать архив.

Данные RLMS содержат множество переменных, чтобы разобраться в них и выбрать нужные понадобится описание переменных - [codebook](https://www.hse.ru/rlms/code). Они находятся по указанной ссылке и необходимо выбрать описание по используемой выборке и волне.


## Загрузка данных

После распаковки архива останется файл .sav, который необходимо загрузить в R с помощью пакета **foreign** - для этого необходимо загрузить сам пакет и использовать функцию **read.spss()**. 

Для загрузки данных в удобном для работы с ними формате необходимо использовать аргумент **to.data.frame = TRUE** - с данным аргументом данные будут загружены в формате *data frame*. Если вам кажется более удобным работать со **значениями переменных**, чем с **метками** (третий и четвертый столбики в описании переменных) - для этого нужно указать аргумент **use.value.labels = FALSE**.

*Множество красных надписей при загрузке данных - это не страшно! Эти сообщения говорят не об ошибке, а о автоматической обработке загружаемых данных. Если красные буквы вас пугают - укажите в чанк кода (chunk) с загрузкой аргументы message=FALSE, warning=FALSE (как это сделано ниже). Эти аргументы не позволяют исполняемому коду показывать сообщения и предупреждения.*

```{r load.data, message=FALSE, warning=FALSE}
library(foreign)
df <- read.spss("rlms/r28i_os_32.sav", to.data.frame = TRUE)
```

Как можно увидеть из области с переменными наши данные содержат 12228 наблюдений по 747 переменным - конечно, все эти данные нам не нужны, для различных тестов нужно будет выбирать необходимые переменные и/или делать подвыборки с помощью фильтрации данных.


## Статистические тесты

В данном документе задачи фокусированы на три статистических теста - **unpaired t-test, paired t-test и chi-square**.

Эти три теста помогают понять есть ли между данными взаимосвязь:    
- **unpaired t-test** (*independent sample t-test*): непарный ти-тест используется для сравнения средних значений одной переменной между двумя (и только двумя) группами (*например, сравнить средний рост мужчин и средний рост женщин*)    
- **paired t-test** (*dependent sample t-test*): парный ти-тест используется для сравнения средних значений одной переменной между двумя (и только двумя) событиями внутри одной группы (*например, средние оценки студентов до начала пандемии и в период пандемии*)   
- **chi-square test**: тест хи-квадрат сравнивает *ожидаемую и реальную частоты встречаемости* (*например, сколько людей относит себя к определённой религии и к определённому социальному классу*)    

*Ещё раз для закрепления - парный ти-тест используется на одной группе и сравнивает значения между двумя состояними этой группы (чаще всего, два временных разреза), а непарный ти-тест сравнивает между собой две разные группы.*

В таблице ниже можно рассмотреть какие статистические тесты необходимо использовать при анализе различных типов данных/переменных:

+----------------+--------------------+--------------------+------------------------+
|                | binary             | nominal / ordinal  | interval / relational  |
+================+====================+====================+========================+
| **binary**     | **chi-square** with| **chi-square**     | **t-test** /           |
|                | Yaets's correction |                    | Wilcoxon test          |
|                |                    |                    | (Mann-Whitney)         |
+----------------+--------------------+--------------------+------------------------+
| **nominal** /  | **chi-square**     | **chi-square**     | ANoVA /                |
| **ordinal**    |                    |                    | Kruskal-Wallis         |
+----------------+--------------------+--------------------+------------------------+
| **interval** / | **t-test** /       | ANoVA /            |                        |
| **relational** | Wilcoxon test      | Kruskal-Wallis     | Correlation            |
|                | (Mann-Whitney)     |                    |                        |
+----------------+--------------------+--------------------+------------------------+


# Paired t-test (парный ти-тест)

## Условия
- нормальность распределения переменных (*визуально и тестами*)   



# Unpaired t-test (непарный ти-тест)

## Условия
- нормальность распределения переменных (*визуально и тестами*)   
- равенство дисперсий для групп   

Задача 1: сравнить средние вес и рост между мужчинами и женщинами
- визуализировать распределения переменных по группам   
- проверить условия для ти-теста    
- значим ли тест?   
- насколько различаются средние значения?   
- насколько различаются средние значения?   

```{r}
# Формирование подвыборок без невалидных значений
df$xm1 <- as.numeric(levels(df$xm1))[df$xm1]
df_weight <- df[df$xm1 < 99999997,]
df$xm2 <- as.numeric(levels(df$xm2))[df$xm2]
df_height <- df[df$xm2 < 99999997,]
```

```{r}
library(ggplot2)
# Визуализация распределения
ggplot(df_weight, aes(xm1, fill = xh5)) + geom_histogram(binwidth = 5)
# Проверка условий
# Нормальность распределения: H0: нет разницы между исследуемым и нормальным распределениями
ks.test(df$xm1[df$xh5 == "МУЖСКОЙ"], "pnorm")
qqnorm(df$xm1[df$xh5 == "МУЖСКОЙ"])
qqline(df$xm1[df$xh5 == "МУЖСКОЙ"], col= 2)
# Равенство дисперсий: оба теста - H0: дисперсии равны
bartlett.test(df$xm1 ~ df$xh5)
var.test(df$xm1 ~ df$xh5)
```

Распределение не нормальное и дисперсии не равны

```{r}
# Визуализация распределения
ggplot(df_height, aes(xm2, fill = xh5)) + geom_histogram(binwidth = 5)
# Проверка условий
# Нормальность распределения: H0: нет разницы между исследуемым и нормальным распределениями
shapiro.test(df$xm1[df$xh5 == "Male"])
shapiro.test(df$xm1[df$xh5 == "Female"])
# Равенство дисперсий: оба теста - H0: дисперсии равны
bartlett.test(df$xm1 ~ df$gndr)
var.test(df$xm1 ~ df$gndr)
```

```{r}
# Проверка условий
# Нормальность распределения: H0: нет разницы между исследуемым и нормальным распределениями
shapiro.test(df$xm1[df$xh5 == "Male"])
shapiro.test(df$xm1[df$xh5 == "Female"])
# Равенство дисперсий: оба теста - H0: дисперсии равны
bartlett.test(df$xm1 ~ df$gndr)
var.test(df$xm1 ~ df$gndr)
```



```{r}
# Ти-тест для веса
t.test(df_weight$xm1 ~ df_weight$xh5, var.equal = T)
```

```{r}
# Ти-тест для роста
t.test(df_height$xm2 ~ df_height$xh5, var.equal = T)
```


# Chi-square (хи-квадрат)

## Условия
- независимость наблюдений    
- не больше 20% ячеек имеют значение 5 или меньше   
- ожидаемые частоты в каждой ячейке не меньше 1    

### Для таблиц 2х2
- Все ожидаемые частоты должны быть больше 10   
- Если некоторые ожидаемые частоты меньше 10, но больше 5 - можно использовать **Yaets's correction for continuinity**    

```{r}
# Show critical value of chi-square test for chosen p-value and degrees of freedom
qchisq(p = 0.95, df = 1)
```
